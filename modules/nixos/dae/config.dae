include {
    @@subscription-file@@
}

global {
    tproxy_port: 12345
    tproxy_port_protect: true
    so_mark_from_dae: 0x9
    log_level: info

    @@wan-interface@@
    @@lan-interface@@

    auto_config_kernel_parameter: true

    tcp_check_url: 'http://cp.cloudflare.com,1.1.1.1,2606:4700:4700::1111'
    tcp_check_http_method: HEAD
    udp_check_dns: 'dns.google:53,8.8.8.8,2001:4860:4860::8888'
    check_interval: 30s
    check_tolerance: 50ms

    dial_mode: domain
    sniffing_timeout: 100ms

    tls_implementation: tls
    allow_insecure: false
}

dns {
    # ipversion_prefer: 4

    # upstream {
    #     alibaba: 'https://dns.alidns.com/dns-query'
    #     cloudflare: 'https://1.1.1.1/dns-query'
    #     google: 'tcp+udp://8.8.8.8:53'
    # }

    # routing {
    #     request {
    #         qname(full: dns.alidns.com) -> google
    #         qname(full: cloudflare-dns.com) -> google
    #         qname(geosite:category-ads-all) -> reject
    #         qtype(https) -> reject
    #         qname(geosite:cn) -> alibaba
    #         fallback: cloudflare
    #         # fallback: google
    #     }

    #     response {
    #         upstream(google) -> accept
    #         upstream(cloudflare) -> accept
    #         ip(geoip:private) && !qname(geosite:cn) -> cloudflare
    #         fallback: accept
    #     }
    # }
}

group {
    proxy {
        policy: min_moving_avg
    }
}

routing {
    pname(systemd-networkd) -> direct

    dip(224.0.0.0/3, 'ff00::/8') -> direct
    dip(geoip:private) -> direct
    domain(suffix: tailscale.com) -> direct

    dport(22) -> direct

    dip(geoip:cn) -> direct
    domain(geosite:cn) -> direct

    fallback: proxy
}
